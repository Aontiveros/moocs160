/*!
* express
* Copyright(c) 2009-2013 TJ Holowaychuk
* Copyright(c) 2013 Roman Shtylman
* Copyright(c) 2014-2015 Douglas Christopher Wilson
* MIT Licensed
*/

// vendor libraries
var express = require('./lib/express');
var mysql = require('mysql');
// var favicon = require('serve-favicon');
// var logger = require('morgan');
var path = require('path');
var stormpath = require('express-stormpath');

var app = express();

// Configure Stormpath.
//
// app.use(stormpath.init(app, {
//  client: {
//     apiKey: {
//       file: express.static("/apikeys.properties")
//     }
//  },
//  application: {
//    href: 'https://api.stormpath.com/v1/applications/a2yy7jjX3nLHWynINDgNM',
//  },
//   web: {
//     login: {
//       nextUri: '/'
//     }
//   }
// }));

app.use(express.static("../../public"));

var connection = mysql.createConnection({
  host     : 'localhost',
  user     : 'root',
  password : 'password',
  database : 'youthcyb_cs160s4g1'
});

connection.connect(function(err){
  if(!err) {
    console.log("Database is connected ... \n\n");
  } else {
    console.log("Error connecting database ... \n\n");
    connection.end();
  }
});

app.get('/search/[a-zA-Z0-9(%20)]+', function (req, res) {
  var term = req.url.substring(8, req.url.lenth);
  term = term.replace(new RegExp('%20', 'g'), ' ');
  //query magic
  var q1 = 'SELECT * FROM course_data WHERE '+
  'title LIKE \'%'+term+'%\' OR '+
  'short_desc LIKE \'%'+term+'%\' OR '+
  'category  LIKE \'%'+term+'%\'';

  connection.query(q1, function(err, rows, fields) {
    if (!err){
      //console.log('The solution is: ', rows);
      res.json(rows);
    }else{
      console.log('Error while performing Query.');
    }});
  });

  app.get('/search', function (req, res) {
    //return any data to prevent error
    res.json(0);
  });

  app.get('/todo',stormpath.loginRequired,function(req,res){
    res.json(1);
  });

  // app.on('stormpath.ready',function(){
    var server = app.listen(80, function () {
      var host = server.address().address;
      var port = server.address().port;

      console.log('App listening on http://%s:%s', host, port);
    });
  // });
