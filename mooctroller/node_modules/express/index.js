/*!
* express
* Copyright(c) 2009-2013 TJ Holowaychuk
* Copyright(c) 2013 Roman Shtylman
* Copyright(c) 2014-2015 Douglas Christopher Wilson
* MIT Licensed
*/

// vendor libraries
var express = require('./lib/express');
var mysql = require('mysql');
// var favicon = require('serve-favicon');
// var logger = require('morgan');
var path = require('path');
var stormpath = require('express-stormpath');

var app = express();
//for parsing post requests
var bodyParser = require('body-parser');
app.use(bodyParser.json()); // support json encoded bodies
app.use(bodyParser.urlencoded({ extended: true })); // support encoded bodies

// Configure Stormpath.
//
// app.use(stormpath.init(app, {
//  client: {
//     apiKey: {
//       file: express.static("/apikeys.properties")
//     }
//  },
//  application: {
//    href: 'https://api.stormpath.com/v1/applications/a2yy7jjX3nLHWynINDgNM',
//  },
//   web: {
//     login: {
//       nextUri: '/'
//     }
//   }
// }));

app.use(express.static("../../public"));

var connection = mysql.createConnection({
  host     : 'localhost',
  user     : 'root',
  password : '',
  database : 'moocs160'
});

connection.connect(function(err){
  if(!err) {
    console.log("Database is connected ... \n\n");
  } else {
    console.log("Error connecting database ... \n\n");
    connection.end();
  }
});

app.get('/search/[a-zA-Z0-9(%20)]+', function (req, res) {
  var term = req.url.substring(8, req.url.lenth);
  term = term.replace(new RegExp('%20', 'g'), ' ');
  //query magic
  var q1 = 'SELECT * FROM course_data WHERE '+
  'title LIKE \'%'+term+'%\' OR '+
  'short_desc LIKE \'%'+term+'%\' OR '+
  'category  LIKE \'%'+term+'%\'';

  connection.query(q1, function(err, rows, fields) {
    if (!err){
      //console.log('The solution is: ', rows);
      res.json(rows);
    }else{
      console.log('Error while performing Query.');
    }});
  });

  app.get('/search', function (req, res) {
    //return any data to prevent error
    res.json(0);
  });

  app.get('/todo',stormpath.loginRequired,function(req,res){
    res.json(1);
  });
  
  //for logging in
  app.post("/loginusr", function(req, res) {
    console.log('Login request:');
    console.log(req.body);
    var usr = req.body.username;
    var pass = req.body.password;
    
    var query = "SELECT * FROM usr_login WHERE " +
    "usr='" + usr +"' AND pass='"+ pass + "'";
    connection.query(query, function(err, rows, fields){
      if (!err){
        if (rows.length == 1){
          res.send();
        }else{
          res.status(401).send();
        }
      }else{
      console.log('Error while performing login query.');
      console.log(err);
      res.status(500).send();
      }
    });
  });
  
  //helper functions to create account
  function verifyPassword(pass){
    var minPassLength = 8;
    var valid = true;
    
    if (pass.length < minPassLength){
      valid = false;
      console.log("Minimum password length is " + minPassLength + " characters");
    }
    
    return valid;
  }

var emailRegex = /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
function verifyEmail(email){
	var valid = emailRegex.test(email);
	
	if (!valid){
		console.log("Email address is not valid");
	}
	
	return valid;
}
  
  //for creating account
  app.post("/createusr", function(req, res) {
    console.log('Create Account Request:');
    console.log(req.body);
    var usr = req.body.username;
    var pass = req.body.password;
    if (verifyEmail(usr) && verifyPassword(pass)){
      var errorMessage = function(err){
        console.log('Error while creating account.');
        console.log(err);
        res.status(500).send();
      };
      
      var checkTableQuery = "SELECT * FROM usr_login WHERE " +
      "usr='" + usr +"' AND pass='"+ pass + "'";
      connection.query(checkTableQuery, function(err, rows, fields){
        if (!err){
          if (rows.length !== 0){
            res.status(400).send();
          }else{
            var insertUsrQuery = "INSERT INTO usr_login " +
                                  "(usr, pass) VALUES ('" + usr +"','" + pass + "');";
            connection.query(insertUsrQuery, function(err, rows, fields){
              if (err){
                errorMessage(err);
              }else{
                res.status(201).send();
              }
            });
          }
        }else{
          errorMessage();
        }
      });
    }
    
  });

  // app.on('stormpath.ready',function(){
    var server = app.listen(80, function () {
      var host = server.address().address;
      var port = server.address().port;

      console.log('App listening on http://%s:%s', host, port);
    });
  // });
