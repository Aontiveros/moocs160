/*!
* express
* Copyright(c) 2009-2013 TJ Holowaychuk
* Copyright(c) 2013 Roman Shtylman
* Copyright(c) 2014-2015 Douglas Christopher Wilson
* MIT Licensed
*/

// vendor libraries
var express = require('./lib/express');
var mysql = require('mysql');
var bodyParser = require('body-parser');
// var favicon = require('serve-favicon');
// var logger = require('morgan');
// var path = require('path');

var app = express();
//for parsing post requests
app.use(bodyParser.json()); // support json encoded bodies
app.use(bodyParser.urlencoded({ extended: true })); // support encoded bodies

app.use(express.static("../../public"));


var connection = mysql.createConnection({
  host     : 'localhost',
  user     : 'root',
  password : 'password',
  database : 'moocs160'
});

connection.connect(function(err){
  if(!err) {
    console.log("Database is connected ... \n\n");
  } else {
    console.log("Error connecting database ... \n\n");
    connection.end();
  }
});

app.get('/search/[a-zA-Z0-9(%20)]+', function (req, res) {
  var term = req.url.substring(8, req.url.lenth);
  term = term.replace(new RegExp('%20', 'g'), ' ');
  //query appending profname to course on course ID
  var q1 = 'SELECT course_data.*, coursedetails.profname FROM course_data NATURAL JOIN coursedetails WHERE '+
  'title LIKE \'%'+term+'%\' OR '+
  'short_desc LIKE \'%'+term+'%\' OR '+
  'category  LIKE \'%'+term+'%\'';


  connection.query(q1, function(err, rows, fields) {
    if (!err){
      // console.log('all rows: ', rows);
      res.json(rows);
    }else{
      console.log('Error while performing Query.');
    }});
  });

  app.get('/search', function (req, res) {
    //return any data to prevent error
    res.json(0);
  });

  app.post("/save_course_data", function(req, res) {
    // console.log("saved: "+ req.body);
    var user = req.body.usr.substring(5,req.body.usr.length);
    var course_data = req.body.data;
    var count;
    var q1 = "SELECT COUNT(*) AS thecount FROM saved_usr_data WHERE user ='"+user+"'";

    connection.query(q1, function(err, rows, fields) {
      if (!err){
        //get the current number of saved courses for priority number
        count = JSON.stringify(rows[0].thecount);
        var q2 = "INSERT INTO saved_usr_data (priority, user, course_data) VALUES ('"+ ((count++)+1) + "','" + user + "','" + course_data + "')";

        //insert the new course with the user's priority
        connection.query(q2, function(err, rows, fields) {
          if (!err){
            res.send();
          }else{
            console.log('Error while setting saved courses ' + err);
            res.status(404).send();
          }
        });
      }else{
        console.log('Error while getting saved courses ' + err);
        res.status(404).send();
      }
    });
  });

  app.post("/update_saved_course/", function(req, res) {

    var user = req.body.usr.substring(5,req.body.usr.length);
    var priority = req.body.data[0][0];
    var course_data = JSON.stringify(req.body.data).replace(/"[0-9]{0,3}",/,"");
    var q1 = "INSERT INTO saved_usr_data (priority, user, course_data) VALUES ('"+ priority + "','" + user + "','" + course_data + "')";

    //insert the new course priority
    connection.query(q1, function(err, rows, fields) {
      if (!err){
        res.send();
      }else{
        console.log('Error while setting saved courses ' + err);
        res.status(404).send();
      }
    });
  });

  app.get("/saved_course_data/[a-zA-Z0-9.@(%18)(%2E)(%2D)(%40)]+", function(req, res) {
    var user = req.url.substring(19,req.url.length);
    var q1 = "SELECT priority,course_data FROM saved_usr_data WHERE user = '"+user+"' ORDER BY priority";

    connection.query(q1, function(err, rows, fields) {
      if (!err){
        res.send(rows);
      }else{
        console.log('Error while getting course data:'+ err);
        res.status(404).send();
      }
    });
  });

  app.post("/reset_courses/[a-zA-Z0-9.@(%18)(%2E)(%2D)(%40)]+", function(req, res) {
    var user = req.url.substring(15,req.url.length);
    //remove all courses for use first
    var q1 = "delete from saved_usr_data where user='" + user + "'";

    connection.query(q1, function(err, rows, fields) {
      if (!err){
        res.send();
      }else{
        console.log('Error while removing course data'+err);
        res.status(404).send();
      }
    });
  });

  app.post("/completed_course/[a-zA-Z0-9.@(%18)(%2E)(%2D)(%40)]+", function(req, res) {
    var user = req.url.substring(18,req.url.length);
    var course_image =req.body[1];
    var title = req.body[2];
    var short_desc =req.body[3];
    var category =req.body[4];
    var start_date =req.body[5];
    var course_length =req.body[6];
    var course_link =req.body[8];
    var q2 = "UPDATE saved_usr_data SET priority = priority - 1 where user ='" + user + "'";
    var q3 = "DELETE from saved_usr_data where user='" + user + "' AND priority < 1" ;
    var q1 = "INSERT into usr_course_history (user, title, short_desc, course_link, start_date, course_length, course_image, category ) values ('"+
    user + "','" +
    title + "','" +
    short_desc + "','" +
    course_link + "','" +
    start_date + "'," +
    course_length.substring(5, course_length.length-6)+ ",'" +
    course_image + "','" +
    category + "')";

    connection.query(q1, function(err, rows, fields) {
      if (!err){
        console.log("Added course to user history.");
        connection.query(q2, function(err, rows, fields) {
          if (!err){
            connection.query(q3, function(err, rows, fields) {
              if (!err){
                console.log("Saved course removed after being completed");
                res.send();
              }else{
                console.log('Error while decrementing priority course data'+err);
                res.status(404).send();
              }
            });
            res.send();
          }else{
            console.log('Error while removing course data'+err);
            res.status(404).send();
          }
        });
        res.send();
      }else{
        console.log('Error while adding course to history'+err);
        res.status(404).send();
      }
    });
  });

  app.post("/delete_course/[a-zA-Z0-9.@(%18)(%2E)(%2D)(%40)]+", function(req, res) {
    var user = req.url.substring(15,req.url.length);
    var q1 = "UPDATE saved_usr_data SET priority = priority - 1";
    var q2 = "delete from saved_usr_data where user='" + user + "' AND priority < 1" ;
    connection.query(q1, function(err, rows, fields) {
      if (!err){
        connection.query(q2, function(err, rows, fields) {
          if (!err){
            console.log("saved course removed after using delete");
          }else{
            console.log('Error while decrementing priority course data'+err);
            res.status(404).send();
          }
        });
        res.send();
      }else{
        console.log('Error while removing course data'+err);
        res.status(404).send();
      }
    });
  });


  app.get("/completed_courses/[a-zA-Z0-9.@(%18)(%2E)(%2D)(%40)]+", function(req, res) {
    var user = req.url.substring(19,req.url.length);
    var q1 = "select * from usr_course_history where user ='"+user+"'";

    connection.query(q1, function(err, rows, fields) {
      if (!err){
        res.send(rows);
      }else{
        console.log("Error while getting course history for "+user +"\nerror: \n" +err);
      }
    });
  });


  //for logging in
  app.post("/loginusr", function(req, res) {
    console.log('Login request:');
    console.log(req.body);
    var usr = req.body.username;
    var pass = req.body.password;

    var query = "SELECT * FROM usr_login WHERE " +
    "usr='" + usr +"' AND pass='"+ pass + "'";
    connection.query(query, function(err, rows, fields){
      if (!err){
        if (rows.length == 1){
          res.send();
        }else{
          res.status(401).send();
        }
      }else{
        console.log('Error while performing login query.');
        console.log(err);
        res.status(500).send();
      }
    });
  });

  //helper functions to create account
  function verifyPassword(pass){
    var minPassLength = 8;
    var valid = true;

    if (pass.length < minPassLength){
      valid = false;
      console.log("Minimum password length is " + minPassLength + " characters");
    }
    return valid;
  }

  var emailRegex = /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
  function verifyEmail(email){
    var valid = emailRegex.test(email);

    if (!valid){
      console.log("Email address is not valid");
    }

    return valid;
  }

  //for creating account
  app.post("/createusr", function(req, res) {
    console.log('Create Account Request:');
    console.log(req.body);
    var usr = req.body.username;
    var pass = req.body.password;
    if (verifyEmail(usr) && verifyPassword(pass)){
      var errorMessage = function(err){
        console.log('Error while creating account.');
        console.log(err);
        res.status(500).send();
      };

      var checkTableQuery = "SELECT * FROM usr_login WHERE " +
      "usr='" + usr +"' AND pass='"+ pass + "'";
      connection.query(checkTableQuery, function(err, rows, fields){
        if (!err){
          if (rows.length !== 0){
            res.status(400).send();
          }else{
            var insertUsrQuery = "INSERT INTO usr_login " +
            "(usr, pass) VALUES ('" + usr +"','" + pass + "');";
            connection.query(insertUsrQuery, function(err, rows, fields){
              if (err){
                errorMessage(err);
              }else{
                res.status(201).send();
              }
            });
          }
        }else{
          errorMessage();
        }
      });
    }
  });

  var server = app.listen(80, function () {
    var host = server.address().address;
    var port = server.address().port;

    console.log('App listening on http://%s:%s', host, port);
  });
